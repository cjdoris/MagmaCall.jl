<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>How it works · MagmaCall</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">MagmaCall</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">MagmaCall.jl</a></li><li><a class="tocitem" href="../guide/">Guide</a></li><li><a class="tocitem" href="../reference/">API Reference</a></li><li class="is-active"><a class="tocitem" href>How it works</a><ul class="internal"><li><a class="tocitem" href="#Interacting-with-the-interpreter"><span>Interacting with the interpreter</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>How it works</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>How it works</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/cjdoris/MagmaCall.jl/blob/master/docs/src/how.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="How-it-works"><a class="docs-heading-anchor" href="#How-it-works">How it works</a><a id="How-it-works-1"></a><a class="docs-heading-anchor-permalink" href="#How-it-works" title="Permalink"></a></h1><p>We keep a Magma interpreter around for the whole Julia session, send it expressions to evaluate, and read its output.</p><p>Because every operation involves sending and receiving synchronous IO messages, which also invoke the Magma interpreter (and parser, etc.), this is all very slow, on the order of 1ms per operation. Hence the <a href="../#Caveat">Caveat</a>.</p><h2 id="Interacting-with-the-interpreter"><a class="docs-heading-anchor" href="#Interacting-with-the-interpreter">Interacting with the interpreter</a><a id="Interacting-with-the-interpreter-1"></a><a class="docs-heading-anchor-permalink" href="#Interacting-with-the-interpreter" title="Permalink"></a></h2><p>Calling <code>MagmaCall.interact(f)</code> will wait for the interpreter to become available, lock it, call <code>f(io)</code> where <code>io</code> is the interpreter process, unlock it, and return whatever <code>f(io)</code> returned. In order to support asyncronous interaction (in particular, the Julia garbage collector is asyncronous, and we have finalizers that delete Magma objects), the function <code>f</code> must complete everything it is doing and leave the interpreter in a state ready for the next operation.</p><p>A typical interaction looks like this:</p><pre><code class="language-julia">interact() do io
    putcmd(io, ..., err=true)
    for line in eachlinetotoken(io, missing)
        # process output...
    end
    checkerr(io)
end</code></pre><p>Here, <code>putcmd</code> sends a command to the interpreter. This essentially is the same as <code>print</code>, except that a semicolon is appended automatically. Further, if <code>err=true</code> (recommended) then the whole thing is wrapped in a <code>try ... catch</code> block to support <code>checkerr</code>.</p><p>Next, we <strong>must process all output that occurred as a result of the command</strong>. Typically we do this by generating a random token, instructing Magma to print it, then reading everything up to that token. In this example, <code>eachlinetotoken(io, tok)</code> is an iterator over each line of output until the token <code>tok</code> is observed. If <code>tok</code> is <code>missing</code>, then a new token is randomly generated and sent to Magma first.</p><p>There are also <code>skiptotoken</code> (ignores everything), <code>echototoken</code> (prints each line to a given IO stream) and <code>readtotoken</code> (reads everything as a string).</p><p>After all output is processed, the call to <code>checkerr(io)</code> checks to see if an error occurred. If so, an appropriate error is raised.</p><p>Since we must process all output, we cannot break out of the loop early. Alternatively, we can call <code>skiptotoken(tok)</code> then <code>break</code>.</p><p>If the loop might throw an error, it must be caught, any remaining output must be processed (e.g. with <code>skiptotoken</code>), and <code>checkerr</code> called before rethrowing it:</p><pre><code class="language-julia">interact() do io
    putcmd(io, ..., err=true)
    tok = puttoken()
    try
        for line in eachlinetotoken(io, tok)
            # process output...
        end
    catch err
        skiptotoken(io, tok)
        checkerr(io)
        rethrow(err)
    end
    checkerr(io)
end</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../reference/">« API Reference</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 30 September 2020 12:15">Wednesday 30 September 2020</span>. Using Julia version 1.5.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
